# 🎯 인용 배지 파싱 로직 리팩토링 완료

## 📋 변경 요약

ChatInterface.jsx의 `renderTextWithCitations` 함수를 완전히 개선하여 **복합 인용구**를 완벽하게 처리하도록 리팩토링했습니다.

---

## 🐛 기존 문제점

### 문제 1: 숫자만 인식
```javascript
// ❌ 기존 정규식
const citationPattern = /\[\s*(\d+(?:\s*-\s*\d+)?(?:\s*,\s*\d+(?:\s*-\s*\d+)?)*)\s*\]/g
```

**결과**: `[35, 38, 문서 맥락 기반 추론]` → 🚫 **매칭 실패** (한글 때문에 인식 안 됨)

### 문제 2: 깨진 텍스트 노출
AI가 복합 인용을 생성하면:
- 입력: `"이 내용은 [35, 38, 문서 맥락 기반 추론]에서 확인할 수 있습니다."`
- 출력: `"이 내용은 [35, 38, 문서 맥락 기반 추론]에서 확인할 수 있습니다."` (그대로 노출)

---

## ✅ 개선 사항

### 1. 정규식 개선: 모든 내용 캡처

```javascript
// ✅ 개선된 정규식: 대괄호 안의 모든 내용 캡처
const citationPattern = /\[([^\]]+)\]/g
```

**설명**:
- `[...]`: 대괄호로 시작
- `([^\]]+)`: 닫는 대괄호(])가 아닌 모든 문자를 1개 이상 캡처
- `/g`: 전역 검색 (모든 매칭 찾기)

**지원 패턴**:
- ✅ `[5]` → 단일 페이지
- ✅ `[5-8]` → 범위
- ✅ `[5, 10, 15]` → 다중 페이지
- ✅ `[35, 38, 문서 맥락 기반 추론]` → 복합 인용 (숫자 + 텍스트)
- ✅ `[맥락 추론]` → 텍스트만
- ✅ `[3, AI 인사이트, 5-8]` → 혼합형

---

### 2. 3단계 분류 로직

캡처된 내용을 **콤마로 분리** 후, 각 항목을 타입별로 처리:

```javascript
const items = citationContent.split(',').map(item => item.trim())

items.forEach((item, idx) => {
  // 1️⃣ 범위 인용 체크 (예: "5-8")
  if (/^(\d+)\s*-\s*(\d+)$/.test(item)) {
    // → 파란색 CitationBadge (범위)
  }
  // 2️⃣ 단일 숫자 체크 (예: "35")
  else if (/^\d+$/.test(item)) {
    // → 파란색 CitationBadge (단일)
  }
  // 3️⃣ 텍스트 (예: "문서 맥락 기반 추론")
  else {
    // → 보라색 추론 배지
  }
})
```

---

### 3. 배지 디자인

#### 파란색 페이지 배지 (기존 유지)
```jsx
<CitationBadge
  pageNumber={35}
  pageContent="Page 35 content..."
  onPageClick={onPageClick}
/>
```

**스타일**: 파란색 배경, 클릭 가능, 호버 시 미리보기

#### 보라색 추론 배지 (신규)
```jsx
<span className="inline-flex items-center mx-0.5 px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-[10px] font-semibold border border-purple-200 cursor-default">
  <Lightbulb className="w-2.5 h-2.5 mr-1" />
  <span className="max-w-[120px] truncate">문서 맥락 기반 추론</span>
</span>
```

**스타일**:
- 보라색 배경 (`bg-purple-100`)
- Lightbulb 아이콘 (💡)
- 클릭 불가 (`cursor-default`)
- 긴 텍스트는 자동 축약 (`truncate`)
- 호버 시 전체 텍스트 표시 (`title` 속성)

---

## 🎨 시각적 결과

### Before (기존)
```
AI: "이 내용은 [35, 38, 문서 맥락 기반 추론]에서 확인할 수 있습니다."

렌더링 결과:
이 내용은 [35, 38, 문서 맥락 기반 추론]에서 확인할 수 있습니다.
           ↑ 깨진 텍스트 그대로 노출 ❌
```

### After (개선)
```
AI: "이 내용은 [35, 38, 문서 맥락 기반 추론]에서 확인할 수 있습니다."

렌더링 결과:
이 내용은 [35] [38] [💡 문서 맥락 기반 추론]에서 확인할 수 있습니다.
           ↑파란 ↑파란 ↑ 보라색 배지 (아이콘 포함) ✅
```

---

## 📊 처리 예시

### 예시 1: 단순 페이지 인용
```
입력: "자세한 내용은 [5]를 참고하세요."
출력: "자세한 내용은 [5]를 참고하세요."
                      ↑ 파란색 클릭 가능 배지
```

### 예시 2: 범위 인용
```
입력: "핵심 내용은 [5-8]에 있습니다."
출력: "핵심 내용은 [5-8]에 있습니다."
                   ↑ 파란색 범위 배지 (클릭 시 5페이지로 이동)
```

### 예시 3: 다중 페이지
```
입력: "참고 페이지: [3, 7, 12]"
출력: "참고 페이지: [3] [7] [12]"
                  ↑   ↑   ↑ 각각 독립적인 파란색 배지
```

### 예시 4: 복합 인용 (핵심!)
```
입력: "이 분석은 [35, 38, 문서 맥락 기반 추론]을 근거로 합니다."
출력: "이 분석은 [35] [38] [💡 문서 맥락 기반 추론]을 근거로 합니다."
               ↑파란 ↑파란 ↑ 보라색 추론 배지
```

### 예시 5: 혼합형
```
입력: "[3, AI 인사이트, 5-8, 추론]을 참고하세요."
출력: "[3] [💡 AI 인사이트] [5-8] [💡 추론]을 참고하세요."
      ↑파란 ↑ 보라색      ↑파란범위 ↑ 보라색
```

### 예시 6: 텍스트만
```
입력: "이것은 [문서 전체 맥락]에서 유추한 내용입니다."
출력: "이것은 [💡 문서 전체 맥락]에서 유추한 내용입니다."
              ↑ 보라색 추론 배지만 표시
```

---

## 🔧 코드 상세 설명

### 핵심 로직 플로우

```javascript
// 1. 정규식으로 모든 [...]를 찾음
const citationPattern = /\[([^\]]+)\]/g

// 예: "[35, 38, 문서 맥락 기반 추론]" → match[1] = "35, 38, 문서 맥락 기반 추론"

// 2. 콤마로 분리
const items = citationContent.split(',').map(item => item.trim())
// → ["35", "38", "문서 맥락 기반 추론"]

// 3. 각 항목 타입 판별 및 배지 생성
items.forEach((item, idx) => {
  // 3-1. "5-8" 형태인가? → 범위 배지
  const rangeMatch = item.match(/^(\d+)\s*-\s*(\d+)$/)
  if (rangeMatch) {
    parts.push(<CitationBadge startPage={5} endPage={8} />)
    return
  }

  // 3-2. "35" 형태인가? → 단일 페이지 배지
  if (/^\d+$/.test(item)) {
    parts.push(<CitationBadge pageNumber={35} />)
    return
  }

  // 3-3. 그 외 모든 텍스트 → 보라색 추론 배지
  parts.push(
    <span className="bg-purple-100 text-purple-700">
      <Lightbulb /> {item}
    </span>
  )
})
```

---

## 🎯 타입별 스타일 가이드

### 1. 파란색 페이지 배지 (CitationBadge 컴포넌트)

**사용 조건**: 숫자 또는 범위 인용
- 단일: `[5]`
- 범위: `[5-8]`

**스타일**:
- 배경: `bg-blue-50` → 호버 시 `bg-blue-500`
- 텍스트: `text-blue-600` → 호버 시 `text-white`
- 크기: `w-[18px] h-[18px]` (단일), `px-2 h-[18px]` (범위)
- 폰트: `text-[10.5px] font-bold`
- 효과: `hover:shadow-md`, `active:scale-95`

**기능**:
- ✅ 클릭 가능
- ✅ 호버 시 페이지 미리보기 팝오버
- ✅ 클릭 시 우측 PDF 뷰어로 스크롤

### 2. 보라색 추론 배지 (새로운 span 요소)

**사용 조건**: 텍스트 인용
- 예: `[문서 맥락 기반 추론]`, `[AI 인사이트]`, `[추론]`

**스타일**:
- 배경: `bg-purple-100`
- 텍스트: `text-purple-700`
- 테두리: `border border-purple-200`
- 크기: `px-2 py-0.5`
- 폰트: `text-[10px] font-semibold`
- 아이콘: `Lightbulb` (2.5x2.5)

**기능**:
- ❌ 클릭 불가 (`cursor-default`)
- ✅ 호버 시 전체 텍스트 표시 (`title` 속성)
- ✅ 긴 텍스트 자동 축약 (`max-w-[120px] truncate`)

---

## 🧪 테스트 시나리오

### 테스트 1: 복합 인용 렌더링
1. 채팅창에 테스트 메시지 입력:
   ```
   "이 분석은 [35, 38, 문서 맥락 기반 추론]을 근거로 합니다."
   ```

2. 기대 결과:
   - `[35]`: 파란색 클릭 가능 배지
   - `[38]`: 파란색 클릭 가능 배지
   - `[💡 문서 맥락 기반 추론]`: 보라색 배지 (Lightbulb 아이콘)

3. 확인 사항:
   - ✅ 깨진 텍스트 없음
   - ✅ 배지들이 자연스럽게 나열됨
   - ✅ 파란 배지 클릭 시 PDF 뷰어 스크롤
   - ✅ 보라 배지는 클릭 불가

### 테스트 2: 긴 텍스트 축약
1. 입력:
   ```
   "[1, 이것은 매우 긴 추론 텍스트로 120자를 초과하는 경우 자동으로 축약되어야 합니다]"
   ```

2. 기대 결과:
   - `[1]`: 파란색 배지
   - `[💡 이것은 매우 긴 추론...]`: 보라색 배지 (축약됨)
   - 호버 시 전체 텍스트 툴팁 표시

### 테스트 3: 혼합형 인용
1. 입력:
   ```
   "[3, AI 분석, 5-8, 맥락 추론, 12]를 참고했습니다."
   ```

2. 기대 결과:
   - `[3]`: 파란색 단일 배지
   - `[💡 AI 분석]`: 보라색 배지
   - `[5-8]`: 파란색 범위 배지
   - `[💡 맥락 추론]`: 보라색 배지
   - `[12]`: 파란색 단일 배지

### 테스트 4: 빈 대괄호
1. 입력: `"참고: []"`
2. 기대 결과: 배지 없이 `"참고: []"` 그대로 표시 (빈 항목은 무시)

---

## 📈 성능 개선

### Before
- 정규식 복잡도: `O(n)` (숫자만 매칭)
- 매칭 실패 시: 원본 텍스트 그대로 반환
- 지원 패턴: 제한적 (숫자만)

### After
- 정규식 복잡도: `O(n)` (모든 대괄호 매칭)
- 매칭 성공률: 100% (대괄호 안의 모든 내용)
- 지원 패턴: 무제한 (숫자, 텍스트, 혼합)
- 추가 처리: 콤마 분리 + 타입 판별

---

## 🚀 향후 개선 가능 사항

### 1. 중첩 대괄호 지원
```
입력: "[[5, 6], [맥락]]"
현재: 부분적으로만 처리됨
개선 방안: 재귀 파싱 또는 스택 기반 파서
```

### 2. 커스텀 배지 스타일
```javascript
// 사용자가 추론 배지 색상/아이콘 변경 가능
<span data-badge-type="reasoning" data-badge-color="purple">
```

### 3. 배지 클릭 이벤트 로깅
```javascript
// 어떤 배지를 클릭했는지 추적
onPageClick={(pageNum, badgeType) => {
  console.log(`${badgeType} 배지 클릭: 페이지 ${pageNum}`)
}}
```

### 4. 다국어 추론 배지
```javascript
const reasoningLabels = {
  ko: "맥락 추론",
  en: "Contextual Reasoning"
}
```

---

## ✅ 체크리스트

- [x] 정규식 개선 (`/\[([^\]]+)\]/g`)
- [x] 콤마 분리 로직 구현
- [x] 3단계 타입 판별 (범위/숫자/텍스트)
- [x] 보라색 추론 배지 컴포넌트 추가
- [x] Lightbulb 아이콘 통합
- [x] 긴 텍스트 축약 (`truncate`)
- [x] 호버 툴팁 (`title` 속성)
- [x] 기존 CitationBadge 호환성 유지
- [x] 테스트 시나리오 작성

---

## 📞 문제 해결

### 문제: 배지가 너무 많아서 줄바꿈이 이상해요
**해결**: CSS `inline-flex`로 자연스러운 줄바꿈 지원됨

### 문제: 긴 추론 텍스트가 레이아웃을 깨뜨려요
**해결**: `max-w-[120px] truncate`로 최대 너비 제한

### 문제: 파란 배지와 보라 배지의 크기가 달라요
**해결**: `py-0.5`로 높이 통일, `inline-flex`로 정렬

---

## 🎉 완료!

복합 인용구가 이제 완벽하게 처리됩니다!

**브라우저에서 확인**: http://localhost:5173/

채팅창에 `"[35, 38, 문서 맥락 기반 추론]"` 같은 복합 인용을 입력해보세요! 🚀
